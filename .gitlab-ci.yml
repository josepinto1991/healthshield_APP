stages:
  - sync

variables:
  GITHUB_USER: "josepint1991"
  GITHUB_REPO: "healthshield_APP"

sync-to-github:
  stage: sync
  image: alpine:latest
  before_script:
    - apk add --no-cache git curl
    - git config --global user.email "gitlab-ci@gitlab.com"
    - git config --global user.name "GitLab CI Bot"
    # Configurar autenticación con GitHub
    - git remote remove github 2>/dev/null || true
  script:
    # Añadir GitHub como remoto usando el token
    - git remote add github "https://$GITHUB_USER:$GITHUB_TOKEN@github.com/$GITHUB_USER/$GITHUB_REPO.git"
    
    # Obtener los últimos cambios de todas las ramas
    - git fetch --all
    
    # Empujar TODAS las ramas a GitHub
    - |
      for branch in $(git branch -r | grep -v '\->' | sed 's/origin\///'); do
        git checkout -b "$branch" "origin/$branch" 2>/dev/null || git checkout "$branch"
        git push github "$branch" --force
        echo "Rama $branch sincronizada"
      done
    
    # Empujar todas las etiquetas
    - git push github --tags --force
    
    echo "✅ Sincronización completa con GitHub"
  rules:
    # Solo se ejecuta en pushes a ramas principales
    - if: '$CI_PIPELINE_SOURCE == "push"'
  only:
    refs:
      - main      # Si tu rama principal se llama main
      - master    # Si tu rama principal se llama master
      - develop   # Si quieres sincronizar develop también
  retry: 2